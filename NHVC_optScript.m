% Optimization for ijrr controller.
% 160330 cpq3R*q3R - qyT
% qbar = [phipy;
%         qKAST;
%         qLAST;
%         cpq3R*q3R - qyT;
%         q3LAbs;
%         qLASW;
%         qKASW];

% Future tasks:

% Completed tasks:

setpath

%% Initial bounds
cpBound = 0.05;
boundSize = 0.03;
qScale = 0.01; 
% q=[qzT; qyT; qxT; q1R; q2R; q3R; q1L; q2L; q3L];
qBound = ones(9,1)*qScale; qBound([1 2 3]) = qScale*0.5;
qBound([4 5 7 8]) = qScale*2; % Greater bounds for links.
dqBound = qBound*2;
% kSigma boundaries (initial 160308 values divided by 20)
% ParamMin(43:48)/20
k1xReach = 0.1; k2xReach = 4.5; k3xReach = 20; 
k1yReach = 0.35; k2yReach = 3.7; k3yReach = 60;

if 1 %% Example optimization
% Start from NHVC0
%% NHVC0, First optimization, 160330
% qbar = [phipy;
%         qKAST;
%         qLAST;
%         cpq3R*q3R - qyT;
%         q3LAbs;
%         qLASW;
%         qKASW];
% [-4,-2,2,4]cm, [0.15,0.075,-0.075,-0.15] vcmx, [0.3,0.15,-0.15,-0.3] vcmy
ParamMin = [ 0.02968913562; -0.006743388517; 0.09600509475; 2.637669608; 3.066898682; 0.02843115466; 2.895380996; 3.427447816; 0.01283574328; 0.04900558557; 0.009326641788; -0.3028792079; -0.9781925987; -0.0812138365; -0.286326429; 0.5555980801; -1.727399497; 0.2021390189; 0.250353106; 3.175824556; 0.08773794638; -0.006568442807; 2.724001551; 1.139013382; 0.4568642344; 2.941200698; 0.07694465074; 0.2244175022; 3.07594017; 1.379342628; 1.144825847; 2.157993518; 0.02746397761; 0.02867930043; 3.329991489; 0.649567416; 0.2049300533; 3.485660899; -0.4201278426; -0.1171039385; 2.590473039; 0.451431193; 1.047730637; 45.5177245; -213.0829486; -3.614160475; -39.19407304; 650.3809072; 0.2758907908]; 
% 3 final cost is 1.57434e+06;
% 3 equality constraints are: 1.184, 0.7636, 4.723, -2.767, 1.727, 2.295, 17.28, 13.14, 11.9, 62.65, -42.48, 21.78, -15.98, -8.519, -20.25, 100.9, 10.11, 131.2, 114.6, -15.53, -6.558, 1.111, -1.422, 25.64, 137.8, 13.46, 3.394, 27.73, 62.09, -79.98, 5.489,  253, -11.19, -2.038, 62.75, -83.85, 178.4 
% 3 inequality constraints are: -273.1, -17.31, -367.4, -314.2, -601.2, -1236, -1.33, -1.069e+05,  -50,  -50,  -50, -27.42, -505.7, -1151,  -50, -1243, -444.3, -887.1, -1910,  -50,  -50, -398.2,  -50,  -50, -4090,  -50,  -50, -1791,  -50,  -50,  -50,    0, -738.9, -323.7, -205.7, -364.4, -401, -1255, 1.304, -9.118e+04,  -50,  -50,  -50, -29.03, -752.9, -1269,  -50, -737.9, -1385, -886.5, -2699,  -50,  -50, -915.7,  -50,  -50, -3301,  -50,  -50, -1780,  -50,  -50,  -50,   -0, -493.7, -303.6, -372.5, -319.6, -598.5, -1249, 7.743, -1.048e+05,  -50,  -50,  -50, -26.96, -628.4, -939.6,  -50, -604.7, -854.3, -1001, -1945,  -50,  -50, -356.6,  -50,  -50, -4055,  -50,  -50, -1834,  -50,  -50,  -50, -1375, -707.4, -306.5, -287.9, -328.7, -461.4, -1498, -9.802, -9.59e+04,  -50,  -50,  -50, -26.46, -818.5, -1301,  -50, -700.9, -1301, -1148, -2873,  -50,  -50, -872.4,  -50,  -50, -3127,  -50,  -50, -1629,  -50,  -50,  -50, -1480, -517.1, -300.6, -361, -320.6, -594.9, -1258, 10.9, -1.059e+05,  -50,  -50,  -50, -27.41, -648.2, -979.2,  -50, -608.6, -880.7, -1035, -1887,  -50,  -50, -413,  -50,  -50, -4113,  -50,  -50, -1778,  -50,  -50,  -50, -1394, -906.6, -186.2, -752, -618.3, -1172, -2584, -38.74, -2.14e+05, -6661, -8339, 183.4, -55.58, -988.7, -2184, -32.12, -1198, -1861, -1848, -4547, 208.4, 101.2, -879.6, 180.3, -248.3, -7453, -1453, -1827, -3468, 64.7, -1766, -2547, -2388, -741.6, -599.3, -745.5, -628.1, -1204, -2473, -12.46, -2.173e+05, -6929, -8071, 183.3, -54.6, -1284, -2101, -11.6, -1184, -1779, -1777, -4043, 131.5, 91.85, -720.4, 107.3, -337.4, -7957, -1957, -1885, -3565, -130.8, -1721, -2043, -2500, -52.12, -44.88, -248.6, -308.3, -879.7, -1256, -45.69, -1.168e+05,  -50,  -50,  -50, -31.69, -312.7, -850.2,  -50, -538.2, -519.6, -297.1, -1250,  -50,  -50, 80.04,  -50,  -50, -4750,  -50,  -50, -1277,  -50,  -50,  -50,   -0, -392.1, -82.06, -381.7, -305.3, -610.7, -1223, -32.67, -1.107e+05,  -50,  -50,  -50, -26.53, -471.7, -1057,  -50, -591.3, -870.9, -688.6, -2310,  -50,  -50, -383.5,  -50,  -50, -3690,  -50,  -50, -1622,  -50,  -50,  -50, -1039, -831.3, -306.2, -105.2, -351.1, -1409, -1554, -90.99, -9.764e+04,  -50,  -50,  -50, -23.07, -200.7, -1326,  -50, -724.3, -809.6, -1062, -2695,  -50,  -50, -473.1,  -50,  -50, -3305,  -50,  -50, -693.3,  -50,  -50,  -50,    0, -465.4, -302.9, -363.5, -321.9, -592, -1279, 9.417, -1.071e+05,  -50,  -50,  -50, -26.92, -645.6, -955,  -50, -596.1, -873.3, -1083, -2035,  -50,  -50, -389.2,  -50,  -50, -3965,  -50,  -50, -1836,  -50,  -50,  -50, -1349, -312.4, -83.52, -312.3, -299.1, -659.2, -1300, -51.63, -1.2e+05,  -50,  -50,  -50, -27.9, -408.5, -1094,  -50, -593.4, -546, -297.9, -2291,  -50,  -50,  240,  -50,  -50, -3709,  -50,  -50, -975,  -50,  -50,  -50, -798, -241.9, -76.88, -316.6, -319.9, -657.1, -1266, -8.1, -1.196e+05,  -50,  -50,  -50, -27.44, -457.6, -945.6,  -50, -549.6, -542.2, -720.2, -1409,  -50,  -50, -113.8,  -50,  -50, -4591,  -50,  -50, -1521,  -50,  -50,  -50, -1069, -327.9, -87.46, -362.1, -304.3, -614.3, -1259, -36.66, -1.141e+05,  -50,  -50,  -50, -27.34, -547.6, -1104,  -50, -595.6, -790.8, -810.3, -2353,  -50,  -50, -248.5,  -50,  -50, -3647,  -50,  -50, -1416,  -50,  -50,  -50, -996.6, -254, -296.3, -342.5, -317.3, -628.5, -1244, -5.908, -1.144e+05,  -50,  -50,  -50, -27.49, -582.9, -992.8,  -50, -564.6, -746.8, -777.6, -1663,  -50,  -50, -289.1,  -50,  -50, -4337,  -50,  -50, -1662,  -50,  -50,  -50, -1169, -578.2, -313, -360.1, -318, -569.9, -1344, 3.425, -9.895e+04,  -50,  -50,  -50, -29.23, -664.7, -1054,  -50, -642, -953.3, -980.3, -2054,  -50,  -50, -451.7,  -50,  -50, -3946,  -50,  -50, -1894,  -50,  -50,  -50, -1419, -431.4, -307.1, -378.4, -305.8, -577.6, -1307, -14.94, -1.032e+05,  -50,  -50,  -50, -27.42, -666, -1104,  -50, -614.5, -935.3, -1010, -2332,  -50,  -50, -394.1,  -50,  -50, -3668,  -50,  -50, -1798,  -50,  -50,  -50, -1285, -881.9, -307.4, -307.4, -334.9, -559.7, -1385, 37.47, -9e+04,  -50,  -50,  -50, -31.25, -673.5, -997.9,  -50, -687.9, -996.7, -1209, -1660,  -50,  -50, -623.3,  -50,  -50, -4340,  -50,  -50, -1560,  -50,  -50,  -50, -1697, -442.8, -318.4, -381.6, -297.9, -551.3, -1400, -30.85, -9.749e+04,  -50,  -50,  -50, -27.89, -684, -1163,  -50, -635.6, -989, -1157, -2689,  -50,  -50, -412.9,  -50,  -50, -3311,  -50,  -50, -1774,  -50,  -50,  -50, -1274, -639.3, -286, -337.9, -322.3, -599.6, -1221, 20.2, -1.08e+05,  -50,  -50,  -50, -26.63, -572.8, -1031,  -50, -616.4, -907.4, -1285, -1722,  -50,  -50, -552.3,  -50,  -50, -4278,  -50,  -50, -1543,  -50,  -50,  -50, -1516, -464.6, -97.62, -369.2, -306.7, -570.5, -1352, -24.98, -1.058e+05,  -50,  -50,  -50, -28.3, -533.1, -1129,  -50, -612.9, -978.4, -1053, -2452,  -50,  -50, -492,  -50,  -50, -3548,  -50,  -50, -1669,  -50,  -50,  -50, -1196, -491.5, -295.8, -359, -315, -592, -1264, 2.642, -1.074e+05,  -50,  -50,  -50, -27.21, -668, -1067,  -50, -606.1, -924.9, -1062, -2030,  -50,  -50, -463.3,  -50,  -50, -3970,  -50,  -50, -1759,  -50,  -50,  -50, -1361, -364.3, -303.6, -371.4, -310.4, -585.7, -1296, -14.64, -1.072e+05,  -50,  -50,  -50, -27.69, -677.2, -1097,  -50, -598.1, -936.8, -975.9, -2253,  -50,  -50, -395.7,  -50,  -50, -3747,  -50,  -50, -1729,  -50,  -50,  -50, -1228, -404.9, -87.39, -388.1, -305.2, -582.8, -1301, -41.4, -1.065e+05,  -50,  -50,  -50, -28.11, -508.4, -1108,  -50, -622.3, -940.1, -695, -2496,  -50,  -50, -415.3,  -50,  -50, -3504,  -50,  -50, -1703,  -50,  -50,  -50, -1031, -362.1, -297.3, -355.7, -314.9, -620.7, -1218, -3.922, -1.104e+05,  -50,  -50,  -50, -27.23, -606.8, -993.7,  -50, -585.1, -827.6, -817, -1694,  -50,  -50, -306,  -50,  -50, -4306,  -50,  -50, -1778,  -50,  -50,  -50, -1262, -289.4, -69.78, -394.2, -306.2, -595.7, -1238, -51.64, -1.072e+05,  -50,  -50,  -50, -21.99, -508.4, -1424,  -50, -576.3, -859.2, 2.685, -3642,  -50,  -50, -340.2,  -50,  -50, -2358,  -50,  -50, -1505,  -50,  -50,  -50, -972.1, -587.7, -285.4, -324.9, -322.3, -626.2, -1195, 18.18, -1.107e+05,  -50,  -50,  -50, -26.65, -524.4, -960.3,  -50, -600.1, -821.5, -1210, -1339,  -50,  -50, -446.2,  -50,  -50, -4661,  -50,  -50, -1500,  -50,  -50,  -50, -1477 
% Costs: RIO 760516, equality 186323, inequality 261335, Poincare 0, Energy 366166
% Max Eig.s are 1, 0.612, and 0.577, yaw restricted = 1,
%    calculated with epsilon of 0.001 and stepDiff of 0.000597556 and 50 step limit
% Max Eig.s are 1, 0.991, and 0.614, yaw restricted = 0,
%    calculated with epsilon of 0.001 and stepDiff of 0.0906651 and 50 step limit

% Average CoM velocity is [-0.0269; 0.736; -1.12e-11] (m/s) at 0.412 (s/step)
% Vcm at vertical is [-0.00985; 0.722; 0.027] (m/s)
% Final Swing Foot Velocity is [0.0186; -0.0102; -0.705] m/s
% Impact losses are 6.697 J
% Swing foot max is 0.102 m
% Sigma max: [49.3; 11.5; 3.92], min: [38.4; 0; 3.92];
% Step distance [-0.254; 0.303; -8.01e-14]; (yaw zeroed out)
% COT is 0.438948
% 0.53-0.81 range of 0.28

% [k1x: 1.04773; k2x 45.5177; k3x: -213.083;
% k1y -3.61416; k2y -39.1941; k3y 650.381];
% HAlpha = [0.53206682 0.5488758573 0.250353106 0.4568642344 0.3604137553 0.429229074;
%  3.161414406 3.117628471 3.175824556 2.941200698 2.892922449 2.852284145;
%  -0.003202125153 0.007716021996 0.08773794638 0.07694465074 0.02136321736 0.01458728226;
%  0.02168776614 0.06001647859 -0.006568442807 0.2244175022 0.04297356753 0.08469356142;
%  2.739387338 2.717880739 2.724001551 3.07594017 3.103604658 3.029908503;
%  0.429229074 0.4949142163 1.139013382 1.379342628 0.707216124 0.53206682];
% HAlpha2 = [0.429229074 0.5439212719 1.144825847 0.2049300533;
%  2.852284145 2.784553638 2.157993518 3.485660899;
%  0.01458728226 0.003294057086 0.02746397761 -0.4201278426;
%  0.08469356142 0.1542268846 0.02867930043 -0.1171039385;
%  3.029908503 2.907081578 3.329991489 2.590473039;
%  0.53206682 0.2401513133 0.649567416 0.451431193];
% PHipLimits = [-0.1115025045; 0.1876947323];
% kSigma = [0.001047730637; 4.55177245e-05; -2.130829486e-07; -0.003614160475; -3.919407304e-05; 6.503809072e-07;    0;    0;    0];
% qPlus5Link = [0.09600509475; 2.637669608; 3.066898682; 2.895380996; 3.427447816];
% dqPlus5Link = [-0.2276120365; -0.9238418527; -0.1107390775; -0.6460548132; -0.4379792208];
% qPlus9Link = [0.02968913562; -0.006743388517; 0.09600509475; 2.637669608; 3.066898682; 0.02843115466; 2.895380996; 3.427447816; 0.01283574328];
% dqPlus9Link = [0.04292747548; 0.05231210181; -0.2276120365; -0.9238418527; -0.1107390775; 0.4221510928; -0.6460548132; -0.4379792208; 0.3002687428];

% phaseScale = [0; 1; 0];
% cp = [0.275891];

increaseRatio = 1.25; numEvals = 300;

end

%% Next optimization

%% Current tasks

%% Future ideas

fprintf('[k1x: %g; k2x %g; k3x: %g;\nk1y %g; k2y %g; k3y %g];\n',ParamMin([43:48]));
fprintf('cp: %g',ParamMin(49:end));

%% Important functions
% fminconiterate
% optimizationFunction3D
% optimization3D

%% Optimization
initialParameters = ParamMin;
deltaUpper = ones(size(initialParameters))*boundSize;
deltaUpper(1:18) = [qBound; dqBound];
deltaUpper([43:48])=[k1xReach; k2xReach; k3xReach; k1yReach; k2yReach; k3yReach];
deltaUpper(49:end) = cpBound;
deltaLower = -deltaUpper; nIterations = 1000; 

% Info for fmincon: http://www.mathworks.com/help/optim/ug/fmincon.html
options=optimset(@fmincon);
options=optimset(options,'MaxFunEvals',numEvals,'TolCon',1e-5,'TolFun',1e-3,'TolX',1e-8,'Algorithm','active-set','Display','iter-detailed','FinDiffRelStep',(10^-3));
options=optimset(options,'UseParallel','always');  
% parpool

[finalParameters, finalValue] = fminconiterate(options, initialParameters, 'optimizationFunction3D', 'notUsed', deltaLower, deltaUpper, nIterations, increaseRatio);
beep % start another optimization when beep sounds

%% Final control solutions:


